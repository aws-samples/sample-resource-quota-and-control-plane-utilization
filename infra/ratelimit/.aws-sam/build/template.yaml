AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "EventBridge \u2192 SQS FIFO \u2192 2 Go Lambdas \n\u2022 One FIFO queue,\
  \ two EB rules \u2192 unique message groups \n\u2022 SQS EventSourceMappings with\
  \ ReportBatchItemFailures \n"
Globals:
  Function:
    Runtime: provided.al2023
    Timeout: 30
    Architectures:
    - arm64
Parameters:
  AssumeRoleHandler:
    Type: String
    Default: bootstrap
    Description: Go handler for the AssumeRole function
  AssumeWebIdentityHandler:
    Type: String
    Default: bootstrap
    Description: Go handler for the AssumeRoleWithWebIdentity function
  Regions:
    Type: String
    Default: us-east-1
    Description: Comma separated list of regions to run solution against
  LogLevel:
    Type: String
    Default: DEBUG
    Description: "Go log\u2010level for Lambda functions"
  CloudWatchLogGroup:
    Type: String
    Default: /lambda/ratelimit/emf
    Description: "CloudWatch log\u2010group for EMFs"
  MetricNamespace:
    Type: String
    Default: CustomMetrics
    Description: CloudWatch metric namespace
  AppName:
    Type: String
    Default: rateLimitUtilization
    Description: Application name used as dimension for Error CallCount Metric.
Resources:
  EventsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: events-queue.fifo
      FifoQueue: true
      ContentBasedDeduplication: true
      VisibilityTimeout: 30
  AssumeRoleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: AssumeRoleRule
      EventBusName: default
      EventPattern:
        detail-type:
        - AWS API Call via CloudTrail
        detail:
          eventName:
          - AssumeRole
      Targets:
      - Id: ToSQS
        Arn:
          Fn::GetAtt:
          - EventsQueue
          - Arn
        InputPath: $.detail
        SqsParameters:
          MessageGroupId: assume-role-group
  AssumeRoleWebIdentityRule:
    Type: AWS::Events::Rule
    Properties:
      Name: AssumeRoleWithWebIdentityRule
      EventBusName: default
      EventPattern:
        detail-type:
        - AWS API Call via CloudTrail
        detail:
          eventName:
          - AssumeRoleWithWebIdentity
      Targets:
      - Id: ToSQS
        Arn:
          Fn::GetAtt:
          - EventsQueue
          - Arn
        InputPath: $.detail
        SqsParameters:
          MessageGroupId: assume-role-web-identity-group
  EventsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
      - Ref: EventsQueue
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AllowAssumeRole
          Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Action:
          - sqs:SendMessage
          - sqs:SendMessageBatch
          Resource:
            Fn::GetAtt:
            - EventsQueue
            - Arn
        - Sid: AllowAssumeRoleWeb
          Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Action:
          - sqs:SendMessage
          - sqs:SendMessageBatch
          Resource:
            Fn::GetAtt:
            - EventsQueue
            - Arn
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      - arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole
      Policies:
      - PolicyName: DescribeLogResources
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:DescribeLogGroups
            - logs:DescribeLogStreams
            Resource: '*'
  AssumeRoleFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: AssumeRoleFunction
    Properties:
      FunctionName: AssumeRoleProcessor
      Handler:
        Ref: AssumeRoleHandler
      CodeUri: AssumeRoleFunction
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Environment:
        Variables:
          REGIONS:
            Ref: Regions
          LOG_LEVEL:
            Ref: LogLevel
          CLOUDWATCH_LOG_GROUP:
            Ref: CloudWatchLogGroup
          METRIC_NAMESPACE:
            Ref: MetricNamespace
          APP_NAME:
            Ref: AppName
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - EventsQueue
              - Arn
            BatchSize: 10
            FunctionResponseTypes:
            - ReportBatchItemFailures
  AssumeRoleWebIdentityFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: AssumeRoleWebIdentityFunction
    Properties:
      FunctionName: AssumeRoleWebIdentityProcessor
      Handler:
        Ref: AssumeWebIdentityHandler
      CodeUri: AssumeRoleWebIdentityFunction
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Environment:
        Variables:
          REGIONS:
            Ref: Regions
          LOG_LEVEL:
            Ref: LogLevel
          CLOUDWATCH_LOG_GROUP:
            Ref: CloudWatchLogGroup
          METRIC_NAMESPACE:
            Ref: MetricNamespace
          APP_NAME:
            Ref: AppName
      Events:
        SQSTrigger2:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - EventsQueue
              - Arn
            BatchSize: 10
            FunctionResponseTypes:
            - ReportBatchItemFailures
Outputs:
  QueueUrl:
    Description: URL of the FIFO queue
    Value:
      Ref: EventsQueue
  AssumeRoleFunctionArn:
    Description: ARN of the AssumeRole Lambda
    Value:
      Fn::GetAtt:
      - AssumeRoleFunction
      - Arn
  AssumeRoleWebIdentityFunctionArn:
    Description: ARN of the AssumeRoleWithWebIdentity Lambda
    Value:
      Fn::GetAtt:
      - AssumeRoleWebIdentityFunction
      - Arn
